<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Pong Game</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<!-- Django 템플릿에서 전달된 정보 -->
{{ room_name|json_script:"room-name" }}
{{ username|json_script:"username" }}

<script>
    // Django 템플릿에서 전달된 정보를 JavaScript로 가져오기
    // const jwtToken = JSON.parse(document.getElementById('jwt_token').textContent);
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const username = JSON.parse(document.getElementById('username').textContent);
    
    let socket = new WebSocket("ws://" + window.location.host + "/ws/game/" + roomName + "/");
    
    
    // 서버로부터 받아온 테이블, 패들 정보
    const tableWidth = 50;
    const tableLength = 100;
    const paddleWidth = 10;

    // Three.js 기본 설정
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 탁구대 생성
    const tableGeometry = new THREE.PlaneGeometry(tableWidth, tableLength);
    const tableMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
    const table = new THREE.Mesh(tableGeometry, tableMaterial);
    table.rotation.x = -Math.PI / 2;
    table.position.y = 0;
    scene.add(table);

    // 공 생성
    const ballGeometry = new THREE.SphereGeometry(1, 32, 32);
    const ballMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
    const ball = new THREE.Mesh(ballGeometry, ballMaterial);
    ball.position.set(0, 1, 0);
    scene.add(ball);

    // 패들 생성
    const paddleGeometry = new THREE.BoxGeometry(paddleWidth, 10, 10);  // 패들의 크기 설정
    const paddleMaterial = new THREE.MeshPhongMaterial({ color: 0x0000ff });  // 패들 색상: 파란색

    const player1Paddle = new THREE.Mesh(paddleGeometry, paddleMaterial);
    player1Paddle.position.set(0, 5, -tableLength / 2 + 20);  // player1 패들의 z 위치 조정
    scene.add(player1Paddle);

    const player2Paddle = new THREE.Mesh(paddleGeometry, paddleMaterial);
    player2Paddle.position.set(0, 5, tableLength / 2 - 20);  // player2 패들의 z 위치 조정
    scene.add(player2Paddle);

    // 조명 추가
    const ambientLight = new THREE.AmbientLight(0x404040);  // 부드러운 환경광 추가
    scene.add(ambientLight);

    const light = new THREE.DirectionalLight(0xffffff, 1.5);  // 기존 조명의 강도를 증가시킴
    light.position.set(0, 100, 100);
    scene.add(light);

    // 카메라 설정
    camera.position.set(0, 75, 150);  // 카메라를 더 가까이 위치시켜 패들이 잘 보이도록 조정
    camera.lookAt(0, 0, 0);

    // 애니메이션 렌더링
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    animate();
    
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if(data.type === 'send_game_state'){
            const ball_position = data.ball_pos;
            const player1_paddle_x = data.player1_paddle_x;
            const player2_paddle_x = data.player2_paddle_x;

            // 공의 위치 업데이트
            ball.position.x = ball_position[0] - tableWidth / 2;
            ball.position.z = ball_position[1] - tableLength / 2;

            // 패들의 위치 업데이트
            player1Paddle.position.x = player1_paddle_x - tableWidth / 2;
            player2Paddle.position.x = player2_paddle_x - tableWidth / 2;
            // console.log(player1_paddle_x, player2_paddle_x);
        }
    };

    socket.onopen = function() {
        console.log("WebSocket connection opened");
    };

socket.onclose = function(event) {
        console.log("WebSocket connection closed:", event);
    };

socket.onerror = function(event) {
        console.error("WebSocket error occurred:", event);
    };
    document.addEventListener('keydown', function(event) {
        let direction = null;
        if (event.key === 'ArrowLeft') {
            console.log('ArrowLeft')
            direction = 'left';
        } else if (event.key === 'ArrowRight') {
            console.log('ArrowRight')
            direction = 'right';
        }
        if (direction) {
            console.log(socket.readyState);
            socket.send(JSON.stringify({
                move_paddle: {
                    username: username,
                    direction: direction
                }
            }));
        }
    });
</script>
</body>
</html>
