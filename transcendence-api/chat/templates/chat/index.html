<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Rooms</title>
    <!-- JWT í† í°ì„ ë©”íƒ€ íƒœê·¸ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤ -->
    <meta name="jwt-token" content="{{ jwt_token }}">
</head>
<body>
    <h1>ì±„íŒ… ðŸ’¬</h1>
    <select id="friend-select">
        <!-- ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ì‚½ìž…ë©ë‹ˆë‹¤ -->
    </select><br>
    <input id="DM-ë³´ë‚´ê¸°" type="button" value="DM ë³´ë‚´ê¸°">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // JWT í† í°ì„ ë©”íƒ€ íƒœê·¸ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function getJwtToken() {
                const metaTag = document.querySelector('meta[name="jwt-token"]');
                return metaTag ? metaTag.content : '';
            }

            // ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ê¸°
            fetch('/api/chat/friend_list/', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getJwtToken()}`  // JWT í† í°ì„ Authorization í—¤ë”ì— ì¶”ê°€
                }
            })
            .then(response => response.json())
            .then(data => {
                const friendSelect = document.getElementById('friend-select');
                data.friends.forEach(friend => {
                    const option = document.createElement('option');
                    option.value = friend.nickname;
                    option.textContent = friend.nickname;
                    friendSelect.appendChild(option);
                });
            });

            // DM ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('DM-ë³´ë‚´ê¸°').onclick = function() {
                const selectedFriend = document.getElementById('friend-select').value;
                if (selectedFriend) {
                    fetch('/api/chat/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getJwtToken()}`  // JWT í† í°ì„ Authorization í—¤ë”ì— ì¶”ê°€
                        },
                        body: JSON.stringify({ friend_nickname: selectedFriend })
                    })
                    .then(response => response.json())
                    .then(data => {
                        window.location.href = `/api/chat/room/${data.room_name}/?token=${getJwtToken()}`;
                    });
                }
            };
        });
    </script>
</body>
</html>
